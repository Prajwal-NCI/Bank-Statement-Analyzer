<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bank Statement Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
    (function enforceLogin() {
        // If userEmail or accessToken is missing, force login
        const accessToken = localStorage.getItem('accessToken');
        const userEmail   = localStorage.getItem('userEmail');

        if (!accessToken || !userEmail) {
            // Optional: clear anything half‑saved
            localStorage.removeItem('accessToken');
            localStorage.removeItem('idToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userEmail');

            // Redirect to login
            window.location.href = 'login.html';
        }
    })();
    </script>

    <style>
        :root {
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --accent: #111111;
            --border: #e5e7eb;

            --error-bg: #fef2f2;
            --error-border: #fecaca;
            --error-text: #7f1d1d;

            --success-bg: #ecfdf3;
            --success-border: #bbf7d0;
            --success-text: #166534;

            --info-bg: #eff6ff;
            --info-border: #bfdbfe;
            --info-text: #1d4ed8;

            --warning-bg: #fff3cd;
            --warning-border: #ffc107;
            --warning-text: #856404;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 0;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: var(--card);
            padding: 15px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            color: var(--text);
            font-size: 20px;
            margin: 0;
            font-weight: 700;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-email {
            color: var(--muted);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .session-timer {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .logout-btn {
            padding: 8px 18px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: background 0.15s ease, transform 0.15s ease,
                        box-shadow 0.15s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.4);
        }

        .container {
            max-width: 960px;
            margin: 100px auto 50px;
            padding: 32px 28px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        h1 {
            text-align: center;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 700;
        }

        h2 {
            color: var(--text);
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
            font-size: 18px;
        }

        h3 {
            color: var(--text);
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            margin-bottom: 18px;
            font-size: 0.9rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .step {
            padding: 4px 10px;
            border-radius: 999px;
            background: #e5e7eb;
            color: var(--muted);
            border: 1px solid #d1d5db;
        }

        .step.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }

        label {
            font-weight: 600;
            margin-top: 18px;
            display: block;
            color: var(--muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-group {
            margin-bottom: 18px;
        }

        select,
        input[type="file"],
        .form-control {
            margin-top: 8px;
            border: 1px solid var(--border);
            padding: 10px 12px;
            border-radius: 8px;
            width: 100%;
            font-size: 0.9rem;
            box-sizing: border-box;
            background: #ffffff;
            color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        select:focus,
        input:focus,
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(17,17,17,0.12);
        }

        .btn {
            background: var(--accent);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            padding: 12px 20px;
            cursor: pointer;
            margin-top: 18px;
            font-weight: 600;
            width: 100%;
            transition: background 0.15s ease, transform 0.15s ease,
                        box-shadow 0.15s ease;
        }

        .btn:hover:not(:disabled) {
            background: #333333;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(15, 23, 42, 0.18);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            /* same styling as .btn, kept for semantic use */
            background: var(--accent);
        }

        .btn-primary:hover:not(:disabled) {
            background: #333333;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
            box-shadow: 0 3px 8px rgba(220, 38, 38, 0.4);
        }

        .status {
            margin-top: 18px;
            padding: 10px 12px;
            border-radius: 8px;
            display: none;
            font-weight: 500;
            font-size: 0.85rem;
            border: 1px solid transparent;
        }

        .status.error {
            background: var(--error-bg);
            border-color: var(--error-border);
            color: var(--error-text);
        }

        .status.success {
            background: var(--success-bg);
            border-color: var(--success-border);
            color: var(--success-text);
        }

        .status.info {
            background: var(--info-bg);
            border-color: var(--info-border);
            color: var(--info-text);
        }

        .status.warning {
            background: var(--warning-bg);
            border-color: var(--warning-border);
            color: var(--warning-text);
        }

        .result-box {
            margin-top: 24px;
            padding-top: 4px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .summary-card {
            background: #111827;
            color: #ffffff;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
        }

        .summary-card .label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 6px;
        }

        .summary-card .value {
            font-size: 1.6em;
            font-weight: 700;
        }

        .category-section {
            margin-bottom: 26px;
            background: #ffffff;
            padding: 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .category-header {
            background: #111827;
            color: #ffffff;
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-size: 1.05rem;
            font-weight: 700;
        }

        .category-total {
            font-size: 1rem;
            font-weight: 600;
        }

        .month-breakdown {
            margin-left: 8px;
        }

        .month-row {
            padding: 8px 10px;
            margin: 6px 0;
            background: #f9fafb;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            border-left: 4px solid #111827;
        }

        .month-name {
            font-weight: 600;
            color: #374151;
        }

        .month-amount {
            color: #111827;
            font-weight: 700;
        }

        .vat-info {
            font-size: 0.85em;
            color: #6b7280;
            margin-left: 6px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 18px;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 3px solid transparent;
            transition: color 0.15s ease, border-color 0.15s ease;
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab:hover {
            color: var(--accent);
        }

        .tab-content {
            display: none;
            padding-top: 18px;
        }

        .tab-content.active {
            display: block;
        }

        .delete-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px dashed var(--warning-border);
            border-radius: 10px;
            background: var(--warning-bg);
            display: none;
        }

        .delete-section h3 {
            color: var(--warning-text);
            margin-top: 0;
            margin-bottom: 8px;
        }

        .delete-section p {
            color: var(--warning-text);
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .settings-section {
            margin: 24px 0;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .settings-section h3 {
            color: var(--text);
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .settings-note {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        .placeholder {
            color: #777;
            font-size: 0.9em;
            text-align: center;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 16px;
            }
            .container {
                margin-top: 90px;
                padding: 24px 18px;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>Bank Statement Analyzer</h1>
    <div class="user-section">
        <span class="user-email" id="userDisplay"></span>
        <span class="session-timer" id="sessionTimer"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</div>

<div class="container">
    <h1>Analyze your spending</h1>
    <p class="subtitle">Upload your bank statement PDF to see detailed totals and VAT estimates.</p>

    <div class="step-indicator">
        <span class="step active">1. Upload PDF</span>
        <span class="step">2. Review overview and details</span>
        <span class="step">3. (Optional) Save or delete</span>
    </div>

    <div class="input-group">
        <label>Upload bank statement (PDF)</label>
        <input type="file" id="fileInput" accept=".pdf"/>
    </div>

    <div class="input-group">
        <label for="countrySelect">Country (for VAT calculation)</label>
        <select id="countrySelect">
            <option value="IE">Ireland (23% VAT)</option>
            <option value="UK">United Kingdom (20% VAT)</option>
            <option value="DE">Germany (19% VAT)</option>
            <option value="FR">France (20% VAT)</option>
            <option value="ES">Spain (21% VAT)</option>
            <option value="IT">Italy (22% VAT)</option>
        </select>
    </div>

    <button class="btn" id="analyzeBtn">Upload and analyze</button>

    <div class="status" id="status"></div>

    <div class="result-box" id="resultBox">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview', this)">Overview</button>
            <button class="tab" onclick="switchTab('monthly', this)">Monthly</button>
            <button class="tab" onclick="switchTab('category', this)">Categories</button>
            <button class="tab" onclick="switchTab('saved', this)">My analyses</button>
            <button class="tab" onclick="switchTab('settings', this)">Settings</button>
        </div>

        <div id="overview" class="tab-content active">
            <p class="placeholder">
                No analysis yet. Upload a statement above to see your summary here.
            </p>
        </div>

        <div id="monthly" class="tab-content">
            <p class="placeholder">
                Monthly breakdown will appear after you run an analysis.
            </p>
        </div>

        <div id="category" class="tab-content">
            <p class="placeholder">
                Category breakdown will appear after you run an analysis.
            </p>
        </div>

        <div id="saved" class="tab-content">
            <h2>My saved analyses</h2>
            <div id="savedAnalysesList">
                <p class="placeholder">No saved analyses yet. Save an analysis from the Overview tab.</p>
            </div>
            <div class="status" id="savedStatus"></div>
        </div>

        <div id="settings" class="tab-content">
            <h2>Settings</h2>

            <div class="settings-section">
                <h3>Change email</h3>
                <p class="settings-note">Update the email address used for login and notifications.</p>
                <label for="newEmail">New email</label>
                <input type="email" class="form-control" id="newEmail" placeholder="new.email@example.com" />
                <button class="btn btn-primary" onclick="changeEmail()">Update email</button>
                <div class="status" id="emailStatus"></div>
            </div>

            <div class="settings-section">
                <h3>Change password</h3>
                <p class="settings-note">Update your password (minimum 8 characters).</p>
                <label for="oldPassword">Current password</label>
                <input type="password" class="form-control" id="oldPassword" placeholder="Enter current password" />
                <label for="newPassword">New password</label>
                <input type="password" class="form-control" id="newPassword" placeholder="Enter new password" />
                <label for="confirmPassword">Confirm new password</label>
                <input type="password" class="form-control" id="confirmPassword" placeholder="Re-enter new password" />
                <button class="btn btn-primary" onclick="changePassword()">Change password</button>
                <div class="status" id="passwordStatus"></div>
            </div>
        </div>
    </div>

    <div class="delete-section" id="deleteSection">
        <h3>File management</h3>
        <p><strong>Note:</strong> Your uploaded file is automatically deleted from our servers after 24 hours.</p>
        <p>If you want to delete it immediately, click the button below:</p>
        <!-- DELETE BUTTON: red style via .btn-danger -->
        <button class="btn btn-danger" id="deleteBtn">Delete file now</button>
        <div class="status" id="deleteStatus"></div>
    </div>
</div>

<script>
let config = null;
const S3_BUCKET = "invoice-management-bucket-prajwal-nci";
let currentAnalysisData = null;
let currentFileName = '';
let lastAnalysisData = { bucket: '', key: '', country: '' };

// show user
const userEmail = localStorage.getItem('userEmail');
if (userEmail) {
    document.getElementById('userDisplay').textContent = userEmail;
}

// ================== SESSION ==================
const SESSION_TIMEOUT = 60 * 60 * 1000;
const WARNING_TIME = 5 * 60 * 1000;
let sessionTimer = null;
let warningTimer = null;
let lastActivityTime = Date.now();

function resetSessionTimer() {
    lastActivityTime = Date.now();
    if (sessionTimer) clearTimeout(sessionTimer);
    if (warningTimer) clearTimeout(warningTimer);
    warningTimer = setTimeout(showSessionWarning, SESSION_TIMEOUT - WARNING_TIME);
    sessionTimer = setTimeout(handleSessionExpiry, SESSION_TIMEOUT);
}

function showSessionWarning() {
    const ok = confirm('Your session will expire in 5 minutes due to inactivity.\n\nClick OK to stay logged in.');
    if (ok) refreshAuthToken(); else logout();
}

function handleSessionExpiry() {
    alert('Your session has expired due to inactivity. You will be redirected to login.');
    localStorage.clear();
    window.location.href = 'login.html';
}

async function refreshAuthToken() {
    const refreshToken = localStorage.getItem('refreshToken');
    if (!refreshToken || !config) {
        handleSessionExpiry();
        return;
    }
    try {
        const endpoint = `https://cognito-idp.${config.cognito.region}.amazonaws.com/`;
        const resp = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-amz-json-1.1',
                'X-Amz-Target': 'AWSCognitoIdentityProviderService.InitiateAuth'
            },
            body: JSON.stringify({
                ClientId: config.cognito.clientId,
                AuthFlow: 'REFRESH_TOKEN_AUTH',
                AuthParameters: { REFRESH_TOKEN: refreshToken }
            })
        });
        const data = await resp.json();
        if (resp.ok && data.AuthenticationResult) {
            localStorage.setItem('accessToken', data.AuthenticationResult.AccessToken);
            localStorage.setItem('idToken', data.AuthenticationResult.IdToken);
            resetSessionTimer();
        } else {
            throw new Error('Token refresh failed');
        }
    } catch (err) {
        console.error('Token refresh error:', err);
        handleSessionExpiry();
    }
}

['mousedown','keydown','scroll','touchstart','click'].forEach(evt => {
    document.addEventListener(evt, () => {
        if (Date.now() - lastActivityTime > 60 * 1000) resetSessionTimer();
    });
});

setInterval(() => {
    const timeLeft = SESSION_TIMEOUT - (Date.now() - lastActivityTime);
    const minutesLeft = Math.max(0, Math.floor(timeLeft / 60000));
    const el = document.getElementById('sessionTimer');
    if (!el) return;
    if (minutesLeft <= 10) {
        el.textContent = minutesLeft > 0 ? `${minutesLeft} minutes left` : '';
        el.style.color = minutesLeft <= 5 ? '#e74c3c' : '#f39c12';
    } else {
        el.textContent = '';
    }
}, 60000);

// ================== CONFIG ==================
async function loadConfig() {
    try {
        const response = await fetch('/api/config');
        if (!response.ok) throw new Error('Config load failed');
        config = await response.json();
        if (localStorage.getItem('accessToken')) resetSessionTimer();
    } catch (err) {
        showStatus('Unable to load configuration. Please refresh the page.', 'error');
        console.error('Config error:', err);
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.clear();
        window.location.href = 'login.html';
    }
}

// ================== UI HELPERS ==================
function showStatus(msg, type, id='status') {
    const el = document.getElementById(id);
    el.className = 'status ' + type;
    el.textContent = msg;
    el.style.display = 'block';
}
function hideStatus(id='status') {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
}

function switchTab(name, btn) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    btn.classList.add('active');
    if (name === 'saved') loadSavedAnalyses();
}

// ================== SETTINGS: EMAIL & PASSWORD ==================
async function changeEmail() {
    const newEmail = document.getElementById('newEmail').value.trim();
    hideStatus('emailStatus');

    if (!newEmail) {
        showStatus('Please enter a new email address.', 'error', 'emailStatus');
        return;
    }
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!re.test(newEmail)) {
        showStatus('Please enter a valid email address.', 'error', 'emailStatus');
        return;
    }
    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
        showStatus('Not authenticated. Please login again.', 'error', 'emailStatus');
        return;
    }
    if (!config) {
        showStatus('Configuration not loaded. Please refresh the page.', 'error', 'emailStatus');
        return;
    }
    try {
        showStatus('Updating email address...', 'info', 'emailStatus');
        const endpoint = `https://cognito-idp.${config.cognito.region}.amazonaws.com/`;
        const resp = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-amz-json-1.1',
                'X-Amz-Target': 'AWSCognitoIdentityProviderService.UpdateUserAttributes'
            },
            body: JSON.stringify({
                AccessToken: accessToken,
                UserAttributes: [{ Name: 'email', Value: newEmail }]
            })
        });
        const data = await resp.json();
        if (resp.ok) {
            showStatus('Email updated. You may need to verify the new email.', 'success', 'emailStatus');
            localStorage.setItem('userEmail', newEmail);
            document.getElementById('userDisplay').textContent = newEmail;
            document.getElementById('newEmail').value = '';
        } else {
            throw new Error(data.message || 'Failed to update email');
        }
    } catch (err) {
        showStatus('Error: ' + err.message, 'error', 'emailStatus');
        console.error('Email update error:', err);
    }
}

async function changePassword() {
    const oldPw = document.getElementById('oldPassword').value;
    const newPw = document.getElementById('newPassword').value;
    const confirmPw = document.getElementById('confirmPassword').value;
    hideStatus('passwordStatus');

    if (!oldPw || !newPw || !confirmPw) {
        showStatus('Please fill in all password fields.', 'error', 'passwordStatus');
        return;
    }
    if (newPw !== confirmPw) {
        showStatus('New passwords do not match.', 'error', 'passwordStatus');
        return;
    }
    if (newPw.length < 8) {
        showStatus('Password must be at least 8 characters long.', 'error', 'passwordStatus');
        return;
    }
    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
        showStatus('Not authenticated. Please login again.', 'error', 'passwordStatus');
        return;
    }
    if (!config) {
        showStatus('Configuration not loaded. Please refresh the page.', 'error', 'passwordStatus');
        return;
    }
    try {
        showStatus('Changing password...', 'info', 'passwordStatus');
        const endpoint = `https://cognito-idp.${config.cognito.region}.amazonaws.com/`;
        const resp = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-amz-json-1.1',
                'X-Amz-Target': 'AWSCognitoIdentityProviderService.ChangePassword'
            },
            body: JSON.stringify({
                AccessToken: accessToken,
                PreviousPassword: oldPw,
                ProposedPassword: newPw
            })
        });
        const data = await resp.json();
        if (resp.ok) {
            showStatus('Password changed successfully.', 'success', 'passwordStatus');
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        } else {
            throw new Error(data.message || 'Failed to change password');
        }
    } catch (err) {
        showStatus('Error: ' + err.message, 'error', 'passwordStatus');
        console.error('Password change error:', err);
    }
}

// ================== SAVE CURRENT ANALYSIS ==================
async function saveCurrentAnalysis() {
    hideStatus('saveStatus');
    if (!currentAnalysisData) {
        showStatus('No analysis to save. Please analyze a statement first.', 'warning', 'saveStatus');
        return;
    }
    const email = localStorage.getItem('userEmail');
    if (!email) {
        showStatus('Not authenticated. Please login again.', 'error', 'saveStatus');
        return;
    }
    try {
        showStatus('Saving analysis...', 'info', 'saveStatus');
        const resp = await fetch(config.api.baseUrl + "/bank/save-analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_email: email,
                analysis_data: currentAnalysisData,
                file_name: currentFileName
            })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to save analysis');
        if (data.is_duplicate) {
            showStatus(`This analysis was already saved on ${data.saved_at_formatted}.`, 'info', 'saveStatus');
        } else {
            showStatus(`Analysis saved on ${data.saved_at_formatted}.`, 'success', 'saveStatus');
        }
    } catch (err) {
        showStatus('Error: ' + err.message, 'error', 'saveStatus');
        console.error('Save error:', err);
    }
}

// ================== LOAD & DELETE SAVED ANALYSES ==================
async function loadSavedAnalyses() {
    const email = localStorage.getItem('userEmail');
    const listDiv = document.getElementById('savedAnalysesList');
    hideStatus('savedStatus');

    if (!email) {
        showStatus('Not authenticated. Please login again.', 'error', 'savedStatus');
        return;
    }

    try {
        showStatus('Loading saved analyses...', 'info', 'savedStatus');
        const resp = await fetch(config.api.baseUrl + "/bank/my-analyses", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_email: email })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to load analyses');

        if (data.count === 0) {
            listDiv.innerHTML =
                '<p class="placeholder">No saved analyses yet. Save an analysis from the Overview tab.</p>';
            hideStatus('savedStatus');
            return;
        }

        hideStatus('savedStatus');
        let html = '<div style="margin-top: 10px;">';

        data.analyses.forEach(analysis => {
            const analysisStr = JSON.stringify(analysis)
                .replace(/'/g, "'").replace(/"/g, '&quot;');
            html += `
                <div class="category-section" style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h3 style="margin: 0; color: #111827;">${analysis.file_name}</h3>
                            <p style="margin: 5px 0; color: #6b7280; font-size: 0.9em;">
                                Saved: ${analysis.saved_at_formatted} | Country: ${analysis.country_code}
                            </p>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-primary"
                                    onclick='viewAnalysis(${analysisStr})'
                                    style="width: auto; padding: 10px 16px;">
                                View
                            </button>
                            <button class="btn btn-danger"
                                    onclick="deleteSavedAnalysis('${analysis.analysis_id}')"
                                    style="width: auto; padding: 10px 16px;">
                                Delete
                            </button>
                        </div>
                    </div>

                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="label">Total spent</div>
                            <div class="value">€${analysis.total_gross.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Net amount</div>
                            <div class="value">€${analysis.total_net.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">VAT paid</div>
                            <div class="value">€${analysis.total_vat.toFixed(2)}</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">Transactions</div>
                            <div class="value">${analysis.transaction_count}</div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        listDiv.innerHTML = html;
    } catch (err) {
        showStatus('Error: ' + err.message, 'error', 'savedStatus');
        console.error('Load error:', err);
    }
}

async function deleteSavedAnalysis(analysisId) {
    const email = localStorage.getItem('userEmail');
    if (!confirm('Delete this saved analysis permanently?')) return;
    if (!email) {
        showStatus('Not authenticated. Please login again.', 'error', 'savedStatus');
        return;
    }
    try {
        showStatus('Deleting analysis...', 'info', 'savedStatus');
        const resp = await fetch(config.api.baseUrl + "/bank/delete-analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_email: email, analysis_id: analysisId })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to delete analysis');
        showStatus('Analysis deleted.', 'success', 'savedStatus');
        await loadSavedAnalyses();
    } catch (err) {
        showStatus('Error: ' + err.message, 'error', 'savedStatus');
        console.error('Delete analysis error:', err);
    }
}

// ================== VIEW SAVED ANALYSIS ==================
function viewAnalysis(analysis) {
    const analysisData = {
        country_code: analysis.country_code,
        transaction_count: analysis.transaction_count,
        monthly_summary: analysis.monthly_summary,
        category_summary: analysis.category_summary
    };
    displayResults(analysisData);
    const firstTab = document.querySelector('.tab');
    if (firstTab) switchTab('overview', firstTab);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ================== ANALYZE BUTTON ==================
document.getElementById('analyzeBtn').onclick = async function() {
    const fileInput = document.getElementById("fileInput");
    const country = document.getElementById('countrySelect').value;
    const deleteSection = document.getElementById('deleteSection');
    const btn = this;

    hideStatus();
    hideStatus('deleteStatus');
    deleteSection.style.display = 'none';

    const file = fileInput.files[0];
    if (!file) {
        showStatus("Please select a PDF file.", 'error');
        return;
    }
    if (!file.name.toLowerCase().endsWith('.pdf')) {
        showStatus("File must be a PDF. Please use your official bank statement PDF.", 'error');
        return;
    }

    if (!config) {
        showStatus('Loading configuration...', 'info');
        await loadConfig();
        if (!config) {
            showStatus('Configuration not available. Please refresh the page.', 'error');
            return;
        }
    }

    btn.disabled = true;
    btn.textContent = 'Uploading...';

    try {
        const timestamp = Date.now();
        const s3Key = 'statements/' + timestamp + '-' + file.name.replace(/\s/g, '-');

        const reader = new FileReader();
        reader.onload = async e => {
            const base64Content = e.target.result.split(',')[1];

            const uploadResp = await fetch(config.api.baseUrl + "/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    filename: s3Key,
                    content: base64Content,
                    contentType: file.type
                })
            });
            if (!uploadResp.ok) {
                const err = await uploadResp.json().catch(() => ({}));
                throw new Error(err.error || "Upload failed");
            }

            btn.textContent = 'Analyzing...';
            showStatus('File uploaded. Analyzing statement...', 'info');

            const email = localStorage.getItem('userEmail');

            const analyzeResp = await fetch(config.api.baseUrl + "/bank/analyze", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    bucket: S3_BUCKET,
                    key: s3Key,
                    country_code: country,
                    user_email: email
                })
            });

            const analyzeData = await analyzeResp.json();
            if (!analyzeResp.ok) {
                throw new Error(analyzeData.error || "Analysis failed. Make sure the PDF is a bank statement, not another type of PDF.");
            }

            lastAnalysisData = { bucket: S3_BUCKET, key: s3Key, country };
            currentAnalysisData = analyzeData;
            currentFileName = file.name;

            displayResults(analyzeData);
            showStatus('Analysis complete.', 'success');
            deleteSection.style.display = 'block';
        };

        reader.readAsDataURL(file);
    } catch (err) {
        showStatus('Error: ' + err.message, 'error');
        console.error(err);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Upload and analyze';
    }
};

// ================== DELETE S3 FILE ==================
document.getElementById('deleteBtn').onclick = async function() {
    if (!lastAnalysisData.key) {
        showStatus('No file to delete.', 'warning', 'deleteStatus');
        return;
    }
    if (!confirm('Are you sure you want to delete this file from storage?')) return;
    try {
        showStatus('Deleting file...', 'info', 'deleteStatus');
        const resp = await fetch(config.api.baseUrl + "/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                bucket: lastAnalysisData.bucket,
                key: lastAnalysisData.key
            })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || "Delete failed");
        showStatus('File deleted successfully.', 'success', 'deleteStatus');
        lastAnalysisData = { bucket: '', key: '', country: '' };
    } catch (err) {
        showStatus('Error: ' + err.message, 'error', 'deleteStatus');
        console.error(err);
    }
};

// ================== DISPLAY RESULTS ==================
function displayResults(data) {
    const monthly = data.monthly_summary || {};
    const categories = data.category_summary || {};

    // Overview
    let totalNet = 0, totalVAT = 0, totalGross = 0;
    Object.values(monthly).forEach(m => {
        totalNet  += m.net_total   || 0;
        totalVAT  += m.vat_total   || 0;
        totalGross+= m.gross_total || 0;
    });

    const overviewDiv = document.getElementById('overview');
    overviewDiv.innerHTML = `
        <h2>Summary</h2>
        <div class="summary-grid">
            <div class="summary-card">
                <div class="label">Total spent</div>
                <div class="value">€${totalGross.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <div class="label">Net amount</div>
                <div class="value">€${totalNet.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <div class="label">VAT paid</div>
                <div class="value">€${totalVAT.toFixed(2)}</div>
            </div>
            <div class="summary-card">
                <div class="label">Transactions</div>
                <div class="value">${data.transaction_count || 0}</div>
            </div>
        </div>

        <button class="btn btn-primary" onclick="saveCurrentAnalysis()" style="margin-top: 20px;">
            Save this analysis
        </button>
        <div class="status" id="saveStatus"></div>
    `;

    // Monthly
    const monthlyDiv = document.getElementById('monthly');
    if (!Object.keys(monthly).length) {
        monthlyDiv.innerHTML = '<p class="placeholder">No monthly data available yet.</p>';
    } else {
        let mHtml = '<h2>Monthly breakdown</h2>';
        Object.entries(monthly).sort().forEach(([month, mData]) => {
            mHtml += `
                <div class="category-section">
                    <div class="category-header">
                        <span class="category-name">${month}</span>
                        <span class="category-total">€${mData.gross_total.toFixed(2)}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                        <div><strong>Net:</strong> €${mData.net_total.toFixed(2)}</div>
                        <div><strong>VAT:</strong> €${mData.vat_total.toFixed(2)}</div>
                        <div><strong>Total:</strong> €${mData.gross_total.toFixed(2)}</div>
                    </div>
                    <h4>By category</h4>
            `;
            Object.entries(mData.by_category || {}).forEach(([cat, amount]) => {
                mHtml += `
                    <div class="month-row">
                        <span class="month-name">${cat}</span>
                        <span class="month-amount">€${amount.toFixed(2)}</span>
                    </div>
                `;
            });
            mHtml += '</div>';
        });
        monthlyDiv.innerHTML = mHtml;
    }

    // Category
    const categoryDiv = document.getElementById('category');
    if (!Object.keys(categories).length) {
        categoryDiv.innerHTML = '<p class="placeholder">No category data available yet.</p>';
    } else {
        let cHtml = '<h2>Category breakdown</h2>';
        Object.entries(categories).forEach(([category, catData]) => {
            cHtml += `
                <div class="category-section">
                    <div class="category-header">
                        <span class="category-name">${category}</span>
                        <span class="category-total">€${catData.gross.toFixed(2)}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                        <div><strong>Count:</strong> ${catData.count}</div>
                        <div><strong>Net:</strong> €${catData.net.toFixed(2)}</div>
                        <div><strong>VAT:</strong> €${catData.vat.toFixed(2)}</div>
                        <div><strong>Total:</strong> €${catData.gross.toFixed(2)}</div>
                    </div>
                    <h4>By month</h4>
                    <div class="month-breakdown">
            `;
            Object.entries(catData.by_month || {}).sort().forEach(([month, mData]) => {
                cHtml += `
                    <div class="month-row">
                        <span class="month-name">${month}</span>
                        <span class="month-amount">
                            €${mData.gross.toFixed(2)}
                            <span class="vat-info">(Net: €${mData.net.toFixed(2)}, VAT: €${mData.vat.toFixed(2)})</span>
                        </span>
                    </div>
                `;
            });
            cHtml += `
                    </div>
                </div>
            `;
        });
        categoryDiv.innerHTML = cHtml;
    }
}

window.addEventListener('load', loadConfig);
</script>

</body>
</html>
